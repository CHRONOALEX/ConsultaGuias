<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronolog칤a de Paquetes Redpack</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding: 20px; font-family: 'Segoe UI', sans-serif; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .table-container { background: white; border-radius: 12px; overflow: hidden; }
        .badge-guia { background-color: #e8f0fe; color: #1967d2; font-weight: bold; padding: 4px 8px; border-radius: 4px; font-size: 0.9em; }
        .sparkline-container { width: 120px; height: 30px; }
        .header-ui { background: #000000; color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .filter-bar { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #dee2e6; }
        #loading { display: none; }
    </style>
</head>
<body>

<div class="container-fluid" style="max-width: 1200px;">
    <div class="header-ui text-center">
        <h2 class="mb-0">Cronolog칤a de Paquetes Redpack</h2>
    </div>

    <div class="card p-4">
        <div class="mb-3">
            <label class="form-label fw-bold">Entrada de Datos (Pegar Gu칤as)</label>
            <textarea id="inputGuias" class="form-control" rows="2" placeholder="Ej: 8012345; 9012345;"></textarea>
        </div>
        <button onclick="realizarConsulta()" class="btn btn-primary w-100 fw-bold" id="btnBusqueda">1. Cargar Datos Generales</button>
        
        <div id="loading" class="text-center mt-3">
            <div class="spinner-border text-primary spinner-border-sm" role="status"></div>
            <span class="ms-2 text-muted">Buscando en base de datos...</span>
        </div>
    </div>

    <div id="resultadoSeccion" class="d-none">
        <div class="filter-bar row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label small fw-bold">Ver por Fecha Espec칤fica:</label>
                <input type="date" id="filtroCalendario" class="form-control">
            </div>
            <div class="col-md-3">
                <button onclick="filtrarPorFecha()" class="btn btn-dark w-100">Filtrar por Fecha</button>
            </div>
            <div class="col-md-3">
                <label class="form-label small fw-bold">Servicio:</label>
                <select id="selectServicio" class="form-select" onchange="filtrarResultados()">
                    <option value="todos">Todos los Servicios</option>
                </select>
            </div>
            <div class="col-md-3 text-end">
                <button onclick="exportarExcel()" class="btn btn-success w-100">游닌 Exportar Excel</button>
            </div>
        </div>

        <div class="table-container shadow-sm">
            <table class="table table-hover align-middle mb-0" id="tablaGuias">
                <thead class="table-dark">
                    <tr>
                        <th>Gu칤a</th>
                        <th>Servicio en Fecha</th>
                        <th>Fecha de Registro</th>
                        <th style="width: 150px;">Track Completo (Sparkline)</th>
                    </tr>
                </thead>
                <tbody id="cuerpoTabla"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const URL_SHEET = 'https://docs.google.com/spreadsheets/d/1w3M--HlDfEsHHmtDZtkPcTFy-K8TX4OsH6mm71Ry12U/gviz/tq?tqx=out:csv&sheet=Hoja1';
    let datosProcesados = []; // Aqu칤 guardamos el historial total por gu칤a

    async function realizarConsulta() {
        const input = document.getElementById('inputGuias').value;
        if (!input.trim()) return alert("Por favor, ingresa n칰meros de gu칤a.");

        document.getElementById('loading').style.display = 'block';
        const guiasUsuario = input.split(/[;\n]/).map(g => g.trim()).filter(g => g !== "");

        try {
            const response = await fetch(URL_SHEET);
            const textoCSV = await response.text();
            const filasRaw = parsearCSV(textoCSV);

            // 1. Filtrar y Omitir "Comparativa Rombo"
            const filtrados = filasRaw.filter(f => 
                guiasUsuario.includes(f[1]) && f[2] !== "Comparativa Rombo"
            );

            // 2. L칩gica Anti-duplicados (Toma el 칰ltimo servicio del d칤a)
            const mapaTemporal = {};
            filtrados.forEach(f => {
                const [fecha, guia, servicio] = f;
                if (!mapaTemporal[guia]) mapaTemporal[guia] = {};
                mapaTemporal[guia][fecha] = servicio; 
            });

            // 3. Procesar datos para tener historial total vs visualizaci칩n
            datosProcesados = Object.keys(mapaTemporal).map(numGuia => {
                const historialMap = mapaTemporal[numGuia];
                const fechasOrdenadas = Object.keys(historialMap).sort((a,b) => new Date(a) - new Date(b));
                
                return {
                    guia: numGuia,
                    fechasDisponibles: fechasOrdenadas,
                    historialDetallado: historialMap, // { "2024-01-01": "Servicio A" }
                    // Datos para el Sparkline (Total de la vida de la gu칤a)
                    sparklineData: fechasOrdenadas.map(f => ({x: f, y: 1}))
                };
            });

            poblarSelector();
            mostrarResultados(datosProcesados); // Por defecto muestra todo lo cargado
            document.getElementById('resultadoSeccion').classList.remove('d-none');
        } catch (e) {
            console.error(e);
            alert("Error al conectar con la base de datos.");
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // Nueva funci칩n para enlistar por fecha seleccionada
    function filtrarPorFecha() {
        const fechaBusqueda = document.getElementById('filtroCalendario').value;
        if (!fechaBusqueda) return alert("Selecciona una fecha en el calendario.");

        // Convertir fecha del input (YYYY-MM-DD) al formato de tus datos si es necesario
        // Aqu칤 asumimos coincidencia de texto, si tu CSV usa DD/MM/YYYY podr칤as necesitar un reformateo
        
        const filtrados = datosProcesados.filter(item => 
            item.fechasDisponibles.includes(fechaBusqueda)
        );

        if (filtrados.length === 0) {
            alert("No hay registros para esa fecha espec칤fica.");
        } else {
            mostrarResultados(filtrados, fechaBusqueda);
        }
    }

    function mostrarResultados(lista, fechaFiltro = null) {
        const cuerpo = document.getElementById('cuerpoTabla');
        cuerpo.innerHTML = "";

        lista.forEach((item, index) => {
            // Si hay un filtro de fecha, mostramos el servicio de esa fecha, 
            // si no, mostramos el 칰ltimo registrado.
            const fechaAMostrar = fechaFiltro || item.fechasDisponibles[item.fechasDisponibles.length - 1];
            const servicioAMostrar = item.historialDetallado[fechaAMostrar];

            const canvasId = `chart-${index}`;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span class="badge-guia">${item.guia}</span></td>
                <td><span class="badge bg-info text-dark">${servicioAMostrar}</span></td>
                <td class="small">${fechaAMostrar}</td>
                <td>
                    <div class="sparkline-container">
                        <canvas id="${canvasId}"></canvas>
                    </div>
                </td>
            `;
            cuerpo.appendChild(tr);
            
            // Renderizar Sparkline con TODO el historial, sin importar el filtro de fecha
            crearSparkline(canvasId, item.fechasDisponibles, item.fechasDisponibles.map(() => 1));
        });
    }

    function crearSparkline(id, labels, data) {
        const ctx = document.getElementById(id).getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: '#1a73e8',
                    barThickness: 5
                }]
            },
            options: {
                plugins: { legend: { display: false }, tooltip: { 
                    callbacks: { label: (context) => `Movimiento: ${labels[context.dataIndex]}` }
                }},
                scales: { x: { display: false }, y: { display: false, beginAtZero: true } },
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    function parsearCSV(str) {
        return str.split(/\r?\n/).map(linea => {
            const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
            return linea.split(regex).map(c => c.replace(/^"|"$/g, '').trim());
        }).slice(1);
    }

    function poblarSelector() {
        const select = document.getElementById('selectServicio');
        const servicios = [...new Set(datosProcesados.map(d => d.historialDetallado[d.fechasDisponibles[d.fechasDisponibles.length-1]]))];
        select.innerHTML = '<option value="todos">Todos los Servicios</option>';
        servicios.forEach(s => { if(s) select.innerHTML += `<option value="${s}">${s}</option>`; });
    }

    function filtrarResultados() {
        const val = document.getElementById('selectServicio').value;
        const filtrados = val === "todos" ? datosProcesados : datosProcesados.filter(d => 
            d.historialDetallado[d.fechasDisponibles[d.fechasDisponibles.length-1]] === val
        );
        mostrarResultados(filtrados);
    }

    function exportarExcel() {
        const wb = XLSX.utils.table_to_book(document.getElementById("tablaGuias"));
        XLSX.writeFile(wb, "Reporte_Filtro_Fecha.xlsx");
    }
</script>
</body>
</html>