<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Operativo - Vista 5/5</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --accent: #f59e0b;
            --danger: #ef4444;
            --bg: #f1f5f9;
            --panel: #ffffff;
            --text-main: #1e293b;
            --header: #0f172a;
        }

        body {
            font-family: 'Lexend', sans-serif;
            margin: 0;
            background-color: var(--bg);
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text-main);
            overflow: hidden;
        }

        header {
            background: var(--header);
            color: white;
            padding: 12px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            z-index: 100;
        }

        .main-layout {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }

        /* SIDEBAR IZQUIERDO */
        .sidebar {
            width: 350px;
            background: var(--panel);
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            z-index: 50;
        }

        .panel-content {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: 100%;
            overflow-y: auto;
        }

        .control-group {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }

        label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        textarea, input, select {
            width: 100%;
            border: 1px solid #cbd5e1;
            padding: 10px;
            border-radius: 8px;
            font-family: inherit;
            font-size: 13px;
            box-sizing: border-box;
        }

        /* BOT√ìN COPIAR */
        .copy-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            margin-top: 5px;
        }

        .copy-btn:hover { background: #1d4ed8; transform: translateY(-1px); }
        .copy-btn:active { transform: translateY(0); }

        /* GANTT */
        .gantt-section {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            overflow: hidden;
        }

        .gantt-card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .gantt-scroll-container {
            flex-grow: 1;
            overflow: auto;
        }

        table.gantt-table {
            border-collapse: separate;
            border-spacing: 0;
            font-size: 12px;
        }

        .gantt-table th {
            background: #f8fafc;
            padding: 12px;
            border-bottom: 2px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 10;
            min-width: 165px;
        }

        .sticky-col {
            position: sticky;
            left: 0;
            background: white !important;
            z-index: 20;
            min-width: 210px;
            padding: 10px 15px;
            font-weight: 600;
            border-right: 3px solid #e2e8f0;
            box-shadow: 4px 0 8px rgba(0,0,0,0.05);
        }

        .pill {
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            color: white;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
            width: 92%;
            margin: 0 auto;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .bg-azul { background: #0056b3; }
        .bg-morado { background: #6f42c1; }
        .bg-rojo { background: #dc3545; }
        .bg-gap { background: #f1f5f9; border: 1px dashed #cbd5e1; color: #94a3b8; }

        .critical-alert {
            border: 2.5px solid var(--accent) !important;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.4);
        }

        .badge-alert {
            display: inline-block;
            background: #fff7ed;
            color: #c2410c;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin-top: 4px;
        }
    </style>
</head>
<body>

<header>
    <div>
        <strong>Redpack <span style="font-weight: 300; opacity: 0.7;">Tracking de Gu√≠as </span></strong>
    </div>
    <div id="dataStatus" style="font-size: 11px;">Conectando...</div>
</header>

<div class="main-layout">
    <div class="sidebar">
        <div class="panel-content">
            <div class="control-group">
                <label>üìÖ Fecha de Enfoque</label>
                <input type="date" id="searchFecha" onchange="processData()">
            </div>

            <div class="control-group">
                <label>üîç Filtrar por Gu√≠as</label>
                <textarea id="searchGuias" placeholder="Pega gu√≠as aqu√≠..." rows="10" oninput="processData()"></textarea>
            </div>

            <div class="control-group">
                <label>üìã Reporte de Datos</label>
                <button class="copy-btn" onclick="copyReport()">
                    <span>üìã</span> Copiar Gu√≠a - D√≠as Iny.
                </button>
                <div id="summaryBox" style="font-size: 11px; margin-top: 10px; color: #64748b;"></div>
            </div>

            <div class="control-group">
                <label>üìä L√≠mite</label>
                <select id="limitView" onchange="processData()">
                    <option value="50">Top 50</option>
                    <option value="100">Top 100</option>
                </select>
            </div>
        </div>
    </div>

    <div class="gantt-section">
        <div class="gantt-card">
            <div id="windowLabel" style="padding: 10px 15px; border-bottom: 1px solid #eee; font-size: 12px; color: #64748b; font-weight: 500;">
                Vista 5/5
            </div>
            <div class="gantt-scroll-container">
                <div id="ganttTarget"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1VTGVDxDRf8v60ZxRaYqUwWqEzaqtZRvUvfzmPqDXul4/export?format=csv';
    let rawData = [];
    let groupedData = {};
    let currentFilteredIds = [];

    const colorMap = {
        'Inyecci√≥n NextDay': 'bg-azul',
        'Inyecci√≥n SameDay': 'bg-morado',
        'Mal Entregado': 'bg-rojo',
        'Devoluci√≥n a Origen / 3 Intentos': 'bg-rojo',
        'No Manifestado(Rojo) / TBM': 'bg-rojo',
        'Fuera de Cobertura': 'bg-rojo',
        'Sobre Da√±ado': 'bg-rojo',
        'Sobre sin Contenido': 'bg-rojo'
    };

    window.onload = () => {
        const today = new Date();
        document.getElementById('searchFecha').value = today.toISOString().split('T')[0];
        init();
    };

    async function init() {
        try {
            const resp = await fetch(SHEET_URL);
            const csv = await resp.text();
            Papa.parse(csv, {
                header: true, skipEmptyLines: true,
                complete: (res) => {
                    rawData = res.data.filter(r => r.Fecha && r.Gu√≠a && r.Servicio);
                    document.getElementById('dataStatus').innerText = 'Datos Online ‚úÖ';
                    processData();
                }
            });
        } catch (e) { document.getElementById('dataStatus').innerText = 'Error ‚ùå'; }
    }

    function parseDate(s) {
        const [d, m, y] = s.split('/');
        return new Date(y, m - 1, d);
    }

    function formatDate(d) {
        return d.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function processData() {
        const guiasInput = document.getElementById('searchGuias').value.split(/[\s,;\n]+/).filter(x => x.length > 0);
        const fechaInput = document.getElementById('searchFecha').value;
        const limit = parseInt(document.getElementById('limitView').value);

        groupedData = {};
        rawData.forEach(row => {
            if (!groupedData[row.Gu√≠a]) {
                groupedData[row.Gu√≠a] = { history: {}, inyDays: 0, first: null, last: null, duration: 0 };
            }
            groupedData[row.Gu√≠a].history[row.Fecha] = row.Servicio;
            if (row.Servicio.includes('Inyecci√≥n')) groupedData[row.Gu√≠a].inyDays++;
        });

        let ids = Object.keys(groupedData);
        ids.forEach(id => {
            const dates = Object.keys(groupedData[id].history).map(d => parseDate(d));
            groupedData[id].first = new Date(Math.min(...dates));
            groupedData[id].last = new Date(Math.max(...dates));
            groupedData[id].duration = Math.ceil((groupedData[id].last - groupedData[id].first) / 86400000) + 1;
        });

        currentFilteredIds = [...ids];
        if (fechaInput) {
            const [y, m, d] = fechaInput.split('-');
            const target = `${d}/${m}/${y}`;
            currentFilteredIds = ids.filter(id => groupedData[id].history[target]);
        }
        if (currentFilteredIds.length === 0 && fechaInput) currentFilteredIds = ids.slice(0, limit);
        if (guiasInput.length > 0) currentFilteredIds = currentFilteredIds.filter(id => guiasInput.includes(id));

        currentFilteredIds.sort((a, b) => groupedData[b].duration - groupedData[a].duration);
        renderGantt(currentFilteredIds.slice(0, limit), fechaInput);
    }

    function renderGantt(ids, fechaInput) {
        const target = document.getElementById('ganttTarget');
        if (ids.length === 0) {
            target.innerHTML = "<div style='padding:50px; text-align:center;'>Sin datos.</div>";
            return;
        }

        let centerDate;
        if (fechaInput) {
            const [y, m, d] = fechaInput.split('-');
            centerDate = new Date(y, m - 1, d);
        } else {
            const allDates = rawData.map(r => parseDate(r.Fecha));
            centerDate = new Date(Math.max(...allDates));
        }

        let startW = new Date(centerDate); startW.setDate(startW.getDate() - 5);
        let endW = new Date(centerDate); endW.setDate(endW.getDate() + 5);

        const timeline = [];
        for (let d = new Date(startW); d <= endW; d.setDate(d.getDate() + 1)) {
            timeline.push(new Date(d));
        }

        document.getElementById('windowLabel').innerText = `Ventana 5/5: ${formatDate(startW)} al ${formatDate(endW)}`;

        let html = `<table class="gantt-table"><thead><tr><th class="sticky-col">Referencia Gu√≠a</th>`;
        timeline.forEach(d => {
            const isC = d.getTime() === centerDate.getTime();
            html += `<th style="${isC ? 'background:#e0f2fe; color:var(--primary); font-weight:700;' : ''}">${formatDate(d).substring(0,5)}</th>`;
        });
        html += `</tr></thead><tbody>`;

        ids.forEach(id => {
            const info = groupedData[id];
            const isAlert = info.inyDays > 6;
            html += `<tr><td class="sticky-col">
                <div style="font-size:13px; color:var(--header)">${isAlert ? '‚ö†Ô∏è ' : ''}${id}</div>
                ${isAlert ? `<div class="badge-alert">Crit: ${info.inyDays}d iny</div>` : `<div style="font-size:10px; color:#94a3b8;">Hist: ${info.duration}d</div>`}
            </td>`;
            
            timeline.forEach(tDate => {
                const dateKey = formatDate(tDate);
                const srv = info.history[dateKey];
                const tTime = tDate.getTime();
                if (srv) {
                    let css = colorMap[srv] || 'bg-gap';
                    if (isAlert && srv.includes('Inyecci√≥n')) css += ' critical-alert';
                    html += `<td><div class="pill ${css}" title="${srv}">${srv}</div></td>`;
                } else if (tTime > info.first.getTime() && tTime < info.last.getTime()) {
                    html += `<td><div class="pill bg-gap" style="opacity:0.25"></div></td>`;
                } else { html += `<td></td>`; }
            });
            html += `</tr>`;
        });
        target.innerHTML = html + `</tbody></table>`;
        document.getElementById('summaryBox').innerText = `Visualizando ${ids.length} gu√≠as.`;
    }

    function copyReport() {
        if (currentFilteredIds.length === 0) return alert("No hay datos para copiar.");
        
        // Crear copia y ordenar por d√≠as de inyecci√≥n descendente
        const sortedData = currentFilteredIds
            .map(id => ({ id: id, iny: groupedData[id].inyDays }))
            .sort((a, b) => b.iny - a.iny);

        let output = "Gu√≠a - D√≠as de inyecci√≥n\n";
        sortedData.forEach(item => {
            output += `${item.id} - ${item.iny}\n`;
        });

        navigator.clipboard.writeText(output).then(() => {
            alert("¬°Reporte copiado! " + sortedData.length + " gu√≠as listas para pegar.");
        });
    }
</script>
</body>

</html>

