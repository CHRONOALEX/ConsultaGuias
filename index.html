<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analista Experto - Hoja Maestra Gantt</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            --azul: #0056b3;
            --morado: #6f42c1;
            --rojo: #dc3545;
            --bg: #f8f9fa;
            --panel: #ffffff;
            --border: #dee2e6;
        }

        body {
            font-family: 'Lexend', sans-serif;
            margin: 0;
            background-color: var(--bg);
            color: #333;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            background: #202124;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .main-container {
            display: grid;
            grid-template-columns: 250px 1fr 250px;
            gap: 10px;
            padding: 10px;
            flex-grow: 1;
            overflow: hidden;
        }

        .panel {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        h3 { margin-top: 0; font-size: 1rem; border-bottom: 2px solid var(--azul); padding-bottom: 5px; }

        textarea, input, select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            box-sizing: border-box;
        }

        /* Gantt Chart Styles */
        .gantt-wrapper {
            overflow: auto;
            position: relative;
            background: white;
        }

        .gantt-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        table.gantt-table {
            border-collapse: collapse;
            font-size: 11px;
            width: max-content;
        }

        .gantt-table th, .gantt-table td {
            border: 1px solid #eee;
            min-width: 40px;
            height: 30px;
            text-align: center;
            padding: 2px;
        }

        .sticky-col {
            position: sticky;
            left: 0;
            background: white;
            z-index: 2;
            min-width: 120px !important;
            font-weight: bold;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }

        .cell-bar {
            height: 80%;
            width: 100%;
            border-radius: 3px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            overflow: hidden;
            white-space: nowrap;
        }

        /* Colors based on Image 2 */
        .bg-azul { background-color: var(--azul); }
        .bg-morado { background-color: var(--morado); }
        .bg-rojo { background-color: var(--rojo); }
        .bg-fill { background-color: #e9ecef; } /* For gaps */

        .status-list {
            list-style: none;
            padding: 0;
            overflow-y: auto;
            font-size: 0.85rem;
        }
        .status-list li {
            padding: 5px;
            border-bottom: 1px solid #eee;
        }

        .loading-overlay {
            position: fixed;
            top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">Cargando datos de Google Sheets...</div>

<header>
    <div><strong>Hoja Maestra</strong> - Sistema de Monitoreo</div>
    <div id="last-update" style="font-size: 0.8rem;"></div>
</header>

<div class="main-container">
    <div class="panel">
        <h3>Buscador por Guías</h3>
        <p style="font-size: 0.7rem; color: #666;">Pega columnas de Excel, usa espacios o ";"</p>
        <textarea id="searchGuias" placeholder="Ej: 87371067; 87373136" rows="10"></textarea>
        <button onclick="processData()" style="background: var(--azul); color:white; border:none; padding:10px; border-radius:4px; cursor:pointer;">Filtrar Guías</button>
        <div id="guiasCount" style="margin-top:10px; font-size: 0.8rem;"></div>
    </div>

    <div class="panel">
        <div class="gantt-controls">
            <h3>Visualización Gantt</h3>
            <select id="limitView" style="width: auto;" onchange="processData()">
                <option value="50">Mostrar 50 guías</option>
                <option value="100">Mostrar 100 guías</option>
                <option value="200">Mostrar 200 guías</option>
                <option value="300">Mostrar 300 guías</option>
            </select>
        </div>
        <div class="gantt-wrapper" id="ganttContainer">
            </div>
    </div>

    <div class="panel">
        <h3>Filtrar por Fecha</h3>
        <input type="date" id="searchFecha" onchange="processData()">
        <div id="fechaResults" class="status-list">
            </div>
    </div>
</div>

<script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1VTGVDxDRf8v60ZxRaYqUwWqEzaqtZRvUvfzmPqDXul4/export?format=csv';
    let rawData = [];

    // Mapeo de colores según imagen 2
    const colorMap = {
        'Inyección NextDay': 'bg-azul',
        'Inyección SameDay': 'bg-morado',
        'Mal Entregado': 'bg-rojo',
        'Devolución a Origen / 3 Intentos': 'bg-rojo',
        'No Manifestado(Rojo) / TBM': 'bg-rojo',
        'Fuera de Cobertura': 'bg-rojo',
        'Sobre Dañado': 'bg-rojo',
        'Sobre sin Contenido': 'bg-rojo'
    };

    async function init() {
        try {
            const response = await fetch(SHEET_URL);
            const csvText = await response.text();
            
            Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    rawData = results.data.filter(row => {
                        // REGLA: Si falta algún dato en las 3 columnas principales, no mostrar
                        const hasData = row['Fecha'] && row['Guía'] && row['Servicio'];
                        // REGLA: Si es Comparativa Rombo, omitir
                        const isNotRombo = row['Servicio'] !== 'Comparativa Rombo';
                        return hasData && isNotRombo;
                    });
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('last-update').innerText = 'Datos cargados: ' + new Date().toLocaleTimeString();
                    processData();
                }
            });
        } catch (error) {
            console.error("Error cargando el sheet:", error);
            alert("No se pudo cargar la información del Google Sheet.");
        }
    }

    function parseDate(dateStr) {
        if(!dateStr) return null;
        const [d, m, y] = dateStr.split('/');
        return new Date(y, m - 1, d);
    }

    function formatDate(date) {
        return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function processData() {
        const guiasFilter = document.getElementById('searchGuias').value.split(/[\s,;]+/).filter(x => x.length > 0);
        const fechaFilter = document.getElementById('searchFecha').value;
        const limit = parseInt(document.getElementById('limitView').value);

        let filtered = [...rawData];

        // Filtro por lista de guías
        if (guiasFilter.length > 0) {
            filtered = filtered.filter(row => guiasFilter.includes(row['Guía']));
        }

        // Agrupar por Guía para obtener estados por día
        const grouped = {};
        filtered.forEach(row => {
            const g = row['Guía'];
            if (!grouped[g]) grouped[g] = {};
            
            // REGLA: Si hay 2 guías el mismo día, muestra el último servicio del día
            // (Asumimos el orden del sheet como cronológico descendente o ascendente)
            grouped[g][row['Fecha']] = row['Servicio'];
        });

        const guiasIds = Object.keys(grouped).slice(0, limit);
        renderGantt(guiasIds, grouped);
        renderFechaPanel(fechaFilter);
    }

    function renderGantt(guiasIds, groupedData) {
        const container = document.getElementById('ganttContainer');
        if (guiasIds.length === 0) {
            container.innerHTML = "<p>No hay datos para mostrar con los filtros seleccionados.</p>";
            return;
        }

        // Obtener rango de fechas global para el Gantt
        let allDates = [];
        guiasIds.forEach(id => {
            Object.keys(groupedData[id]).forEach(d => allDates.push(parseDate(d)));
        });
        allDates.sort((a, b) => a - b);
        
        const minDate = new Date(allDates[0]);
        const maxDate = new Date(allDates[allDates.length - 1]);
        
        // Generar array de todas las fechas en el rango
        const timeline = [];
        let curr = new Date(minDate);
        while (curr <= maxDate) {
            timeline.push(new Date(curr));
            curr.setDate(curr.getDate() + 1);
        }

        let html = `<table class="gantt-table"><thead><tr><th class="sticky-col">Guía</th>`;
        timeline.forEach(d => {
            html += `<th>${formatDate(d).substring(0,5)}</th>`;
        });
        html += `</tr></thead><tbody>`;

        guiasIds.forEach(id => {
            html += `<tr><td class="sticky-col">${id}</td>`;
            
            let lastKnownService = null;
            let guideDates = Object.keys(groupedData[id]).map(d => parseDate(d).getTime());
            let firstDate = Math.min(...guideDates);
            let lastDate = Math.max(...guideDates);

            timeline.forEach(tDate => {
                const dateKey = formatDate(tDate);
                const service = groupedData[id][dateKey];
                const tTime = tDate.getTime();

                if (service) {
                    const colorClass = colorMap[service] || 'bg-fill';
                    html += `<td><div class="cell-bar ${colorClass}" title="${service}">${service.substring(0,8)}</div></td>`;
                    lastKnownService = service;
                } else if (tTime > firstDate && tTime < lastDate) {
                    // REGLA: Rellenar huecos sin etiqueta
                    const colorClass = colorMap[lastKnownService] || 'bg-fill';
                    html += `<td><div class="cell-bar ${colorClass}" style="opacity: 0.4;"></div></td>`;
                } else {
                    html += `<td></td>`;
                }
            });
            html += `</tr>`;
        });

        html += `</tbody></table>`;
        container.innerHTML = html;
    }

    function renderFechaPanel(filterDate) {
        const resultsDiv = document.getElementById('fechaResults');
        if (!filterDate) {
            resultsDiv.innerHTML = "<p style='color:#999'>Selecciona una fecha para ver el resumen diario.</p>";
            return;
        }

        // Convertir YYYY-MM-DD a DD/MM/YYYY
        const [y, m, d] = filterDate.split('-');
        const formattedSearch = `${d}/${m}/${y}`;

        const dayData = rawData.filter(row => row['Fecha'] === formattedSearch);
        
        if (dayData.length === 0) {
            resultsDiv.innerHTML = "<li>No hay movimientos en esta fecha.</li>";
            return;
        }

        let html = "<ul>";
        dayData.forEach(row => {
            html += `<li><strong>${row['Guía']}</strong>: ${row['Servicio']}</li>`;
        });
        html += "</ul>";
        resultsDiv.innerHTML = html;
    }

    // Iniciar carga
    init();
</script>

</body>
</html>