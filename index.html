<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analista Pro - Monitor con Alertas</title>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            --azul: #0056b3;
            --morado: #6f42c1;
            --rojo: #dc3545;
            --alerta: #ff9800;
            --bg: #f0f2f5;
            --panel: #ffffff;
            --border: #e0e0e0;
            --header: #1a1c1e;
        }

        body {
            font-family: 'Lexend', sans-serif;
            margin: 0;
            background-color: var(--bg);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            background: var(--header);
            color: white;
            padding: 12px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .main-layout {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .sidebar.collapsed {
            width: 0;
            padding: 0;
            opacity: 0;
            pointer-events: none;
        }

        .toggle-btn {
            background: var(--header);
            color: white;
            border: 1px solid #444;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .gantt-section {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            overflow: hidden;
            background: #fff;
        }

        .gantt-scroll-container {
            flex-grow: 1;
            overflow: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        table.gantt-table {
            border-collapse: separate;
            border-spacing: 0;
            font-size: 11px;
            width: max-content;
        }

        .gantt-table th {
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 3;
            padding: 12px;
            border-bottom: 2px solid var(--border);
        }

        .sticky-col {
            position: sticky;
            left: 0;
            background: white !important;
            z-index: 4;
            min-width: 160px;
            padding: 10px 15px;
            font-weight: 600;
            border-right: 3px solid var(--azul) !important;
            box-shadow: 4px 0 6px rgba(0,0,0,0.05);
        }

        /* Alerta Cr√≠tica */
        .alert-row {
            background-color: #fff9f0 !important;
        }
        .alert-icon {
            color: var(--alerta);
            font-size: 1.1rem;
            margin-right: 5px;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        .bar {
            height: 26px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 9px;
            padding: 0 5px;
            cursor: help;
            white-space: nowrap;
            margin: 0 auto;
            width: 92%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .bar.critical-inyeccion {
            border: 2px solid var(--alerta);
        }

        .bg-azul { background: var(--azul); }
        .bg-morado { background: var(--morado); }
        .bg-rojo { background: var(--rojo); }
        .bg-gap { background: #eee; color: #999; border: 1px solid #ddd; }

        textarea, input, select {
            width: 100%;
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-family: inherit;
        }

        h3 { margin: 0 0 15px 0; font-size: 1rem; color: var(--header); display: flex; align-items: center; }
    </style>
</head>
<body>

<header>
    <div>
        <button class="toggle-btn" onclick="togglePanel('sideLeft')">‚ò∞ Filtros</button>
        <strong style="margin-left: 15px;">Dashboard Maestro de Gu√≠as</strong>
    </div>
    <div id="statusContainer">
        <span id="dataStatus" style="font-size: 0.8rem; margin-right: 15px;">Cargando...</span>
        <button class="toggle-btn" onclick="togglePanel('sideRight')">Resumen ‚ò∞</button>
    </div>
</header>

<div class="main-layout">
    <div class="sidebar" id="sideLeft">
        <h3>Buscador de Gu√≠as</h3>
        <textarea id="searchGuias" placeholder="Pega gu√≠as aqu√≠..." rows="12" oninput="processData()"></textarea>
        <p style="font-size: 0.75rem; color: #666;">
            ‚ö†Ô∏è <b>Alerta Autom√°tica:</b> Se marcar√°n con un √≠cono las gu√≠as que superen los 6 d√≠as en proceso de inyecci√≥n.
        </p>
    </div>

    <div class="gantt-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div id="activeFilters" style="font-size: 0.85rem; color: #444;"></div>
            <select id="limitView" style="width: auto; margin: 0;" onchange="processData()">
                <option value="50">Ver 50 gu√≠as</option>
                <option value="100">Ver 100 gu√≠as</option>
                <option value="200">Ver 200 gu√≠as</option>
            </select>
        </div>

        <div class="gantt-scroll-container">
            <div id="ganttTarget"></div>
        </div>
    </div>

    <div class="sidebar" id="sideRight">
        <h3>Filtro por Fecha</h3>
        <input type="date" id="searchFecha" onchange="processData()">
        <div id="fechaList"></div>
    </div>
</div>

<script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/1VTGVDxDRf8v60ZxRaYqUwWqEzaqtZRvUvfzmPqDXul4/export?format=csv';
    let rawData = [];
    let groupedData = {};

    const colorMap = {
        'Inyecci√≥n NextDay': 'bg-azul',
        'Inyecci√≥n SameDay': 'bg-morado',
        'Mal Entregado': 'bg-rojo',
        'Devoluci√≥n a Origen / 3 Intentos': 'bg-rojo',
        'No Manifestado(Rojo) / TBM': 'bg-rojo',
        'Fuera de Cobertura': 'bg-rojo',
        'Sobre Da√±ado': 'bg-rojo',
        'Sobre sin Contenido': 'bg-rojo'
    };

    async function init() {
        try {
            const resp = await fetch(SHEET_URL);
            const csv = await resp.text();
            Papa.parse(csv, {
                header: true,
                skipEmptyLines: true,
                complete: (res) => {
                    rawData = res.data.filter(r => r.Fecha && r.Gu√≠a && r.Servicio && r.Servicio !== 'Comparativa Rombo');
                    document.getElementById('dataStatus').innerText = '‚úÖ Datos Sincronizados';
                    processData();
                }
            });
        } catch (e) { console.error(e); }
    }

    function togglePanel(id) {
        document.getElementById(id).classList.toggle('collapsed');
    }

    function parseDate(s) {
        const [d, m, y] = s.split('/');
        return new Date(y, m - 1, d);
    }

    function formatDate(d) {
        return d.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function processData() {
        const guiasInput = document.getElementById('searchGuias').value.split(/[\s,;\n]+/).filter(x => x.length > 0);
        const fechaInput = document.getElementById('searchFecha').value;
        const limit = parseInt(document.getElementById('limitView').value);

        groupedData = {};
        rawData.forEach(row => {
            if (!groupedData[row.Gu√≠a]) {
                groupedData[row.Gu√≠a] = { history: {}, inyeccionCount: 0, first: null, last: null, totalTrajectory: 0 };
            }
            groupedData[row.Gu√≠a].history[row.Fecha] = row.Servicio;
            if (row.Servicio.includes('Inyecci√≥n')) groupedData[row.Gu√≠a].inyeccionCount++;
        });

        let guiasIds = Object.keys(groupedData);
        
        guiasIds.forEach(id => {
            const dates = Object.keys(groupedData[id].history).map(d => parseDate(d));
            groupedData[id].first = new Date(Math.min(...dates));
            groupedData[id].last = new Date(Math.max(...dates));
            groupedData[id].totalTrajectory = Math.ceil((groupedData[id].last - groupedData[id].first) / (1000 * 60 * 60 * 24)) + 1;
        });

        if (fechaInput) {
            const [y, m, d] = fechaInput.split('-');
            const target = `${d}/${m}/${y}`;
            guiasIds = guiasIds.filter(id => groupedData[id].history[target]);
            document.getElementById('activeFilters').innerText = `üìÖ Filtrando por d√≠a: ${target}`;
        } else {
            document.getElementById('activeFilters').innerText = `üìä Todas las gu√≠as (Ordenadas por trayectoria)`;
        }

        if (guiasInput.length > 0) {
            guiasIds = guiasIds.filter(id => guiasInput.includes(id));
        }

        // Ordenar por d√≠as de trayectoria
        guiasIds.sort((a, b) => groupedData[b].totalTrajectory - groupedData[a].totalTrajectory);

        renderGantt(guiasIds.slice(0, limit));
    }

    function renderGantt(ids) {
        const target = document.getElementById('ganttTarget');
        if (ids.length === 0) {
            target.innerHTML = "<p style='padding:20px'>Sin resultados para los filtros aplicados.</p>";
            return;
        }

        let globalMin = new Date(Math.min(...ids.map(id => groupedData[id].first)));
        let globalMax = new Date(Math.max(...ids.map(id => groupedData[id].last)));
        
        const timeline = [];
        for (let d = new Date(globalMin); d <= globalMax; d.setDate(d.getDate() + 1)) {
            timeline.push(new Date(d));
        }

        let html = `<table class="gantt-table"><thead><tr><th class="sticky-col">ID Gu√≠a</th>`;
        timeline.forEach(d => html += `<th>${formatDate(d).substring(0,5)}</th>`);
        html += `</tr></thead><tbody>`;

        ids.forEach(id => {
            const info = groupedData[id];
            const hasAlert = info.inyeccionCount > 6;
            const rowClass = hasAlert ? 'alert-row' : '';

            html += `<tr class="${rowClass}"><td class="sticky-col">
                ${hasAlert ? '<span class="alert-icon" title="Alerta: M√°s de 6 d√≠as en Inyecci√≥n">‚ö†Ô∏è</span>' : ''}
                ${id}
                <div style="font-size:9px; font-weight:normal; color:#777">Trayectoria: ${info.totalTrajectory}d</div>
            </td>`;
            
            let currentStatus = null;
            timeline.forEach(tDate => {
                const dateStr = formatDate(tDate);
                const status = info.history[dateStr];
                const tTime = tDate.getTime();

                if (status) {
                    currentStatus = status;
                    let tooltip = status;
                    let barClass = colorMap[status] || 'bg-gap';
                    
                    if (status.includes('Inyecci√≥n')) {
                        let countTillNow = 0;
                        Object.keys(info.history).forEach(d => {
                            if (parseDate(d) <= tDate && info.history[d].includes('Inyecci√≥n')) countTillNow++;
                        });
                        tooltip = `D√≠a ${countTillNow} de Inyecci√≥n. ${hasAlert ? '(¬°CR√çTICO!)' : ''}`;
                        if (hasAlert) barClass += ' critical-inyeccion';
                    }

                    html += `<td><div class="bar ${barClass}" title="${tooltip}">${status.substring(0,8)}..</div></td>`;
                } 
                else if (tTime > info.first.getTime() && tTime < info.last.getTime()) {
                    html += `<td><div class="bar bg-gap" style="opacity:0.2"></div></td>`;
                } 
                else {
                    html += `<td></td>`;
                }
            });
            html += `</tr>`;
        });

        html += `</tbody></table>`;
        target.innerHTML = html;
    }

    init();
</script>
</body>
</html>