<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta Masiva de Gu√≠as</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { background-color: #f4f6f9; padding-top: 40px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .container { max-width: 950px; }
        .card { border: none; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .btn-primary { background-color: #1a73e8; border: none; padding: 10px 20px; font-weight: 600; }
        .btn-primary:hover { background-color: #1557b0; }
        .table thead { background-color: #202124; color: white; }
        .badge-guia { background-color: #e8f0fe; color: #1967d2; font-weight: bold; padding: 6px 10px; border-radius: 6px; }
        #loading { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="card p-4">
        <h2 class="text-center mb-4" style="color: #202124;">Consulta de Gu√≠as</h2>
        
        <div class="mb-3">
            <label class="form-label fw-bold">N√∫meros de Gu√≠a (separe con punto y coma ;)</label>
            <textarea id="inputGuias" class="form-control" rows="3" placeholder="Ejemplo: 123456; 789012; 345678;"></textarea>
            <div class="form-text">Puedes pegar una lista masiva de gu√≠as separadas por ; o saltos de l√≠nea.</div>
        </div>

        <button onclick="realizarConsulta()" class="btn btn-primary w-100" id="btnBusqueda">
            CONSULTAR DATOS
        </button>

        <div id="loading" class="text-center my-4">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Buscando movimientos en el archivo vinculado...</p>
        </div>

        <div id="errorDiv" class="alert alert-danger d-none mt-3"></div>

        <div id="resultadoSeccion" class="d-none mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Movimientos Detectados:</h5>
                <button onclick="exportarExcel()" class="btn btn-success btn-sm">üì• Descargar Excel</button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle" id="tablaGuias">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Gu√≠a</th>
                            <th>Servicio</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpoTabla"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // Link proporcionado
    const URL_SHEET = 'https://docs.google.com/spreadsheets/d/1w3M--HlDfEsHHmtDZtkPcTFy-K8TX4OsH6mm71Ry12U/gviz/tq?tqx=out:csv&sheet=Hoja1';

    async function realizarConsulta() {
        const input = document.getElementById('inputGuias').value;
        const loader = document.getElementById('loading');
        const errorDiv = document.getElementById('errorDiv');
        const seccion = document.getElementById('resultadoSeccion');
        const cuerpo = document.getElementById('cuerpoTabla');
        const btn = document.getElementById('btnBusqueda');

        if (!input.trim()) {
            alert("Por favor, ingresa al menos un n√∫mero de gu√≠a.");
            return;
        }

        // Interfaz de carga
        loader.style.display = 'block';
        errorDiv.classList.add('d-none');
        seccion.classList.add('d-none');
        cuerpo.innerHTML = "";
        btn.disabled = true;

        // Limpiar gu√≠as ingresadas (maneja ; y saltos de l√≠nea)
        const guiasUsuario = input.split(/[;\n]/)
            .map(g => g.trim())
            .filter(g => g !== "");

        try {
            const response = await fetch(URL_SHEET);
            if (!response.ok) throw new Error("No se pudo leer la hoja. Aseg√∫rate de que el acceso sea 'Cualquier persona con el enlace'.");
            
            const textoCSV = await response.text();
            const filas = parsearCSV(textoCSV);

            // Filtrado: Columna A (0) = Fecha, Columna B (1) = Gu√≠a, Columna C (2) = Servicio
            const filtrados = filas.filter(f => {
                const valorGuia = String(f[1]).trim();
                return guiasUsuario.includes(valorGuia);
            });

            if (filtrados.length === 0) {
                errorDiv.textContent = "No se encontraron coincidencias para las gu√≠as ingresadas.";
                errorDiv.classList.remove('d-none');
            } else {
                filtrados.forEach(f => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="text-nowrap">${f[0]}</td>
                        <td><span class="badge-guia">${f[1]}</span></td>
                        <td>${f[2]}</td>
                    `;
                    cuerpo.appendChild(tr);
                });
                seccion.classList.remove('d-none');
            }
        } catch (err) {
            errorDiv.innerHTML = `<b>Error:</b> ${err.message}`;
            errorDiv.classList.remove('d-none');
        } finally {
            loader.style.display = 'none';
            btn.disabled = false;
        }
    }

    // Procesa el CSV respetando las comas internas de las celdas
    function parsearCSV(str) {
        const lineas = str.split(/\r?\n/);
        return lineas.map(linea => {
            const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
            return linea.split(regex).map(c => c.replace(/^"|"$/g, '').trim());
        }).slice(1); // Ignora encabezados
    }

    function exportarExcel() {
        const tabla = document.getElementById("tablaGuias");
        const wb = XLSX.utils.table_to_book(tabla, { sheet: "Resultados_Consulta" });
        XLSX.writeFile(wb, "Consulta_Guias.xlsx");
    }
</script>

</body>
</html>