<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Consulta Masiva</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding-top: 30px; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .btn-primary { background-color: #1a73e8; border: none; font-weight: 600; }
        .badge-guia { background-color: #e8f0fe; color: #1967d2; font-weight: bold; padding: 5px 10px; border-radius: 4px; }
        .kpi-card { background: #fff; border-left: 5px solid #1a73e8; }
        #graficoContenedor { position: relative; height: 300px; width: 100%; }
    </style>
</head>
<body>

<div class="container">
    <div class="card p-4 mb-4">
        <h2 class="text-center mb-4">ðŸ“Š Consulta de GuÃ­as</h2>
        
        <div class="mb-3">
            <label class="form-label fw-bold">Ingresar NÃºmeros de GuÃ­a</label>
            <textarea id="inputGuias" class="form-control" rows="3" placeholder="Pegue sus guÃ­as aquÃ­ (separadas por ; o enter)"></textarea>
        </div>

        <button onclick="realizarConsulta()" class="btn btn-primary w-100 py-2" id="btnBusqueda">
            CONSULTAR Y GENERAR REPORTE
        </button>

        <div id="loading" class="text-center my-4" style="display: none;">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Procesando datos...</p>
        </div>
    </div>

    <div id="errorDiv" class="alert alert-danger d-none mb-4"></div>

    <div id="resultadoSeccion" class="d-none">
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card kpi-card p-3">
                    <small class="text-muted text-uppercase fw-bold">Total GuÃ­as</small>
                    <h2 id="statTotal" class="mb-0">0</h2>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card p-3 h-100">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Filtrar por Servicio:</label>
                            <select id="selectServicio" class="form-select form-select-sm" onchange="filtrarResultados()">
                                <option value="todos">Todos los servicios</option>
                            </select>
                        </div>
                        <div class="col-md-6 text-end">
                            <button onclick="exportarExcel()" class="btn btn-success btn-sm mt-3">ðŸ“¥ Descargar Excel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card p-3 mb-4">
            <h6 class="fw-bold mb-3">Tendencia por Fechas</h6>
            <div id="graficoContenedor">
                <canvas id="graficoFechas"></canvas>
            </div>
        </div>

        <div class="card p-0 overflow-hidden">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="tablaGuias">
                    <thead class="table-dark">
                        <tr>
                            <th>Fecha</th>
                            <th>NÃºmero de GuÃ­a</th>
                            <th>Servicio</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpoTabla"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const URL_SHEET = 'https://docs.google.com/spreadsheets/d/1w3M--HlDfEsHHmtDZtkPcTFy-K8TX4OsH6mm71Ry12U/gviz/tq?tqx=out:csv&sheet=Hoja1';
    
    let datosGlobales = [];
    let miGrafico = null;

    async function realizarConsulta() {
        const input = document.getElementById('inputGuias').value;
        const loader = document.getElementById('loading');
        const errorDiv = document.getElementById('errorDiv');
        const btn = document.getElementById('btnBusqueda');

        if (!input.trim()) return alert("Ingresa guÃ­as primero.");

        loader.style.display = 'block';
        errorDiv.classList.add('d-none');
        btn.disabled = true;

        const guiasUsuario = input.split(/[;\n]/).map(g => g.trim()).filter(g => g !== "");

        try {
            const response = await fetch(URL_SHEET);
            const textoCSV = await response.text();
            const filas = parsearCSV(textoCSV);

            datosGlobales = filas.filter(f => guiasUsuario.includes(String(f[1]).trim()));

            if (datosGlobales.length === 0) {
                errorDiv.textContent = "No se encontraron coincidencias.";
                errorDiv.classList.remove('d-none');
                document.getElementById('resultadoSeccion').classList.add('d-none');
            } else {
                poblarSelector(datosGlobales);
                aplicarVisualizacion(datosGlobales);
                document.getElementById('resultadoSeccion').classList.remove('d-none');
            }
        } catch (err) {
            errorDiv.textContent = "Error al conectar con los datos: " + err.message;
            errorDiv.classList.remove('d-none');
        } finally {
            loader.style.display = 'none';
            btn.disabled = false;
        }
    }

    function parsearCSV(str) {
        return str.split(/\r?\n/).map(linea => {
            const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
            return linea.split(regex).map(c => c.replace(/^"|"$/g, '').trim());
        }).slice(1);
    }

    function poblarSelector(datos) {
        const select = document.getElementById('selectServicio');
        const servicios = [...new Set(datos.map(f => f[2]))];
        select.innerHTML = '<option value="todos">Todos los servicios</option>';
        servicios.forEach(s => {
            if(s) select.innerHTML += `<option value="${s}">${s}</option>`;
        });
    }

    function filtrarResultados() {
        const servicio = document.getElementById('selectServicio').value;
        const filtrados = servicio === "todos" 
            ? datosGlobales 
            : datosGlobales.filter(f => f[2] === servicio);
        aplicarVisualizacion(filtrados);
    }

    function aplicarVisualizacion(datos) {
        const cuerpo = document.getElementById('cuerpoTabla');
        cuerpo.innerHTML = "";
        const conteoFechas = {};

        datos.forEach(f => {
            cuerpo.innerHTML += `<tr>
                <td>${f[0]}</td>
                <td><span class="badge-guia">${f[1]}</span></td>
                <td>${f[2]}</td>
            </tr>`;
            conteoFechas[f[0]] = (conteoFechas[f[0]] || 0) + 1;
        });

        document.getElementById('statTotal').textContent = datos.length;
        renderizarGrafico(Object.keys(conteoFechas).sort(), Object.values(conteoFechas));
    }

    function renderizarGrafico(labels, data) {
        const ctx = document.getElementById('graficoFechas').getContext('2d');
        if (miGrafico) miGrafico.destroy();
        miGrafico = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Cantidad de GuÃ­as',
                    data: data,
                    backgroundColor: '#1a73e8',
                    borderRadius: 5
                }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function exportarExcel() {
        const wb = XLSX.utils.table_to_book(document.getElementById("tablaGuias"));
        XLSX.writeFile(wb, "Reporte_Guias.xlsx");
    }
</script>

</body>
</html>